# Data Model: RAG Vector Database with Chunking

## Entities

### DocumentChunk
- Attributes:
  - `id`: string (unique identifier, generated by vector store)
  - `content`: string (chunk text content)
  - `source_file`: string (path to source Markdown file)
  - `chunk_index`: integer (position/index of chunk within source file)
  - `embedding`: vector<float> (embedding vector, stored in vector store)
  - `metadata`: dict (additional metadata: source_file, chunk_index, content_hash for deduplication)
- Validation:
  - Content must be non-empty string
  - Source file path must be absolute or resolvable relative path
  - Chunk index must be non-negative integer
- Notes:
  - Embedding is generated by Ollama embedding model
  - Metadata used for deduplication (content + source_file uniqueness check)

### VectorDatabase
- Attributes:
  - `location`: string (path to `data/db/` directory)
  - `store_type`: string (constant: "ChromaDB")
  - `collection_name`: string (default: "documents" or configurable)
  - `chunk_count`: integer (derived: count of chunks in store)
  - `source_documents`: set<string> (derived: unique source file paths)
- Validation:
  - Directory path must be writable (for persistence)
  - Collection must exist or be creatable
- Notes:
  - Persisted on disk in ChromaDB's SQLite format
  - Supports incremental additions with deduplication

### ChunkingConfiguration
- Attributes:
  - `chunk_size`: integer (character count per chunk, default: 1000)
  - `chunk_overlap`: integer (character overlap between chunks, default: 200)
- Validation:
  - `chunk_size` must be positive integer > 0
  - `chunk_overlap` must be non-negative integer < `chunk_size`
- Notes:
  - Loaded from environment variables with defaults
  - Used by `RecursiveCharacterTextSplitter`

### RetrievalConfiguration
- Attributes:
  - `top_k`: integer (number of top chunks to retrieve, default: 4)
  - `min_similarity`: float (minimum similarity threshold, 0.0 to 1.0, default: 0.0)
- Validation:
  - `top_k` must be positive integer > 0
  - `min_similarity` must be float in range [0.0, 1.0]
- Notes:
  - Loaded from environment variables with defaults
  - Used by ChromaDB retriever for filtering results

### ModelConfiguration
- Attributes:
  - `embedding_model`: string (Ollama embedding model name, e.g., "nomic-embed-text")
  - `query_model`: string (Ollama LLM model name, e.g., "llama2", "mistral")
  - `ollama_base_url`: string (default: "http://localhost:11434")
- Validation:
  - Model names must be non-empty strings
  - Models must be available in local Ollama installation (validated at initialization)
- Notes:
  - Loaded from environment variables (required: embedding_model, query_model)
  - Base URL configurable but defaults to local Ollama

### Query
- Attributes:
  - `text`: string (natural language question)
  - `timestamp`: datetime (ISO 8601, when query was submitted)
- Validation:
  - Text must be non-empty string
- Notes:
  - Submitted via CLI command
  - Used to generate query embedding for similarity search

### QueryResponse
- Attributes:
  - `answer`: string (generated answer text only, no source metadata)
  - `retrieved_chunks`: integer (number of chunks that met similarity threshold, for internal use only)
- Validation:
  - Answer must be non-empty string if chunks were found
  - Empty answer indicates no relevant chunks found (below similarity threshold)
- Notes:
  - Only answer text is returned to user (per FR-011)
  - Internal tracking of chunk count for observability/logging

### ProcessingResult
- Attributes:
  - `source_file`: string (path to processed Markdown file)
  - `status`: enum { `success`, `failure` }
  - `chunks_added`: integer (number of new chunks added, 0 if deduplication prevented all)
  - `chunks_skipped`: integer (number of chunks skipped due to deduplication)
  - `message`: string (error message on failure)
  - `processing_time_ms`: integer (time taken to process file)
- Validation:
  - Source file path must exist and be readable
  - Status must be one of the enum values
- Notes:
  - Tracks deduplication outcomes (chunks_added vs chunks_skipped)
  - Used for summary reporting

### ProcessingJob
- Attributes:
  - `start_time`: datetime (ISO 8601)
  - `end_time`: datetime (ISO 8601)
  - `total_files`: integer (number of files processed)
  - `succeeded`: integer (number of files successfully processed)
  - `failed`: integer (number of files that failed)
  - `total_chunks_added`: integer (sum of chunks added across all files)
  - `results`: list<`ProcessingResult`>
- Derived:
  - `duration_ms`: integer (end_time - start_time)
- Notes:
  - Similar structure to `ConversionJob` from feature 001 for consistency
  - Tracks chunk-level statistics for observability

## Relationships

- A `VectorDatabase` contains many `DocumentChunk`s.
- A `DocumentChunk` references exactly one source file (via `source_file` attribute).
- A `Query` is processed against a `VectorDatabase` to produce a `QueryResponse`.
- A `ProcessingJob` processes many source files and produces many `ProcessingResult`s.
- `ChunkingConfiguration`, `RetrievalConfiguration`, and `ModelConfiguration` are singleton configuration objects used by processing and query operations.

## State Transitions

- **Processing Flow**: 
  - Markdown file → read content → chunk with `ChunkingConfiguration` → generate embeddings with `ModelConfiguration.embedding_model` → check deduplication in `VectorDatabase` → add new chunks → `ProcessingResult` (success/failure)
  
- **Query Flow**:
  - `Query` → generate query embedding with `ModelConfiguration.embedding_model` → similarity search in `VectorDatabase` with `RetrievalConfiguration` → filter by similarity threshold → generate answer with `ModelConfiguration.query_model` → `QueryResponse`

- **Database State**:
  - Empty database → processing adds chunks → populated database
  - Populated database → processing adds more chunks (with deduplication) → larger populated database
  - Populated database → query operations read-only → no state change

## Notes

- **Deduplication Logic**: Before adding a chunk, check if a chunk with the same `content` and `source_file` already exists in the vector database. If exists, skip adding. This ensures FR-013 compliance (no duplicate chunks from same source file).
- **Metadata Strategy**: ChromaDB metadata store tracks `source_file` and `chunk_index` for each chunk, enabling efficient filtering and deduplication queries.
- **Persistence**: ChromaDB stores data in SQLite database files within `data/db/` directory. Database persists between command invocations.
- **Configuration Loading**: All configuration loaded from `.env` file at startup. Missing required variables (embedding_model, query_model) trigger validation errors before processing.

